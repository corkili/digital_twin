# 基于 Ubuntu 22.04
FROM crpi-7x0z5py955uoyio4.cn-hangzhou.personal.cr.aliyuncs.com/corkili/linux_amd64_ubuntu:22.04

# 设置非交互模式
ENV DEBIAN_FRONTEND=noninteractive

# 使用阿里云源替换默认源
RUN sed -i 's@//.*archive.ubuntu.com@//mirrors.aliyun.com@g' /etc/apt/sources.list

# 安装 OpenJDK 11 和 Maven
RUN apt-get update && \
    apt-get install -y openjdk-11-jdk maven && \
    rm -rf /var/lib/apt/lists/*

# 设置 Maven 阿里云镜像源
RUN mkdir -p /root/.m2 && \
    echo '<settings><mirrors><mirror><id>aliyunmaven</id><mirrorOf>*</mirrorOf><name>阿里云公共仓库</name><url>https://maven.aliyun.com/repository/public</url></mirror></mirrors></settings>' > /root/.m2/settings.xml

# 创建工作目录
RUN mkdir -p /app
WORKDIR /app

# 拷贝本地项目到镜像
COPY . /app/dt_server

# 执行构建脚本
RUN cd dt_server && chmod +x build.sh && ./build.sh

# 设置默认端口环境变量
ENV SERVER_PORT=8081

# 设置容器启动命令（默认后台启动，使用环境变量端口）
# CMD ["/bin/bash", "-c", "/app/dt_server/run.sh -b -p ${SERVER_PORT:-8081}"]